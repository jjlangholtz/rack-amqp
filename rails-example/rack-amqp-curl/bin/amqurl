#!/usr/bin/env ruby

require 'optparse'
require 'pp'
require 'rack/amqp/curl'

options = {
  http_method: 'GET',
  broker_connection: { host: 'localhost' }
}

OptionParser.new do |opts|
  opts.banner = "Usage: amqurl [options] [URL...]"

  opts.on '-X [OPTIONAL]', '--request [OPTIONAL]', 'Specify the HTTP request method (GET, POST, etc)' do |v|
    options[:http_method] = v.upcase
  end

  opts.on_tail '--version', 'Show Version' do
    puts Rack::AMQP::Curl::VERSION
    exit
  end

  # TODO support -T (upload file)
end.parse!

url = ARGV[0]

raise "Need to specify a URL before continuing" unless url

EM.run do
  Fiber.new {
    client = Rack::AMQP::Curl::Client.new( options[:broker_connection] )
    response = client.request(url, options)
    puts "response:"
    pp response
    EM.stop
  }.resume
end

# vi:ft=ruby
